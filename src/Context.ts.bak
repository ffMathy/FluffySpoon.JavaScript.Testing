import { areArgumentsEqual } from "./Utilities";
import { AllArguments } from "./Arguments";

export abstract class ProxyPropertyContextBase {
    name: string;

    type: 'function' | 'object';

    abstract clone(): ProxyPropertyContextBase;

    constructor() {
        this.name = null;
        this.type = null;
    }
}

export class ProxyPropertyContext extends ProxyPropertyContextBase {
    type: 'object';
    
    mimicks: Function;
    returnValues: any[];

    constructor() {
        super();
        this.type = 'object';
    }

    clone() {
        const newObject = new ProxyPropertyContext();
        newObject.name = this.name;
        newObject.mimicks = this.mimicks;

        if(this.returnValues)
            newObject.returnValues = [...this.returnValues];

        return newObject;
    }
}

export class ProxyMethodPropertyContext extends ProxyPropertyContextBase {
    method: ProxyMethodContext;

    type: 'function';

    constructor() {
        super();

        this.type = 'function';
        this.method = new ProxyMethodContext();
    }

    clone() {
        const newObject = new ProxyMethodPropertyContext();
        newObject.name = this.name;
        newObject.method = this.method.clone();

        return newObject;
    }
}

export class ProxyMethodContext {
    arguments: any[];
    returnValues: any[];
    mimicks: Function;

    constructor() {
        this.arguments = [];
    }

    clone() {
        const newObject = new ProxyMethodContext();
        newObject.arguments = [...this.arguments];
        newObject.mimicks = this.mimicks;

        if(this.returnValues)
            newObject.returnValues = [...newObject.returnValues];

        return newObject;
    }
}

export class ProxyCallRecords {
    expected: ProxyExpectation;
    actual: ProxyCallRecord[];

    constructor() {
        this.expected = null;
        this.actual = [];
    }
}

export class ProxyExpectation {
    callCount: number;
    negated: boolean;
    propertyName: string;
    arguments: Array<any>;

    constructor() {
        this.callCount = void 0;
        this.negated = false;
    }
}

export class ProxyObjectContext {
    property: ProxyPropertyContext|ProxyMethodPropertyContext;
    calls: ProxyCallRecords;

    constructor() {
        this.calls = new ProxyCallRecords();
        this.property = new ProxyPropertyContext();
    }

    setExpectations(count: number, negated: boolean) {
        const call = new ProxyExpectation();
        call.callCount = count;
        call.negated = negated;
        call.propertyName = null;

        this.calls.expected = call;
    }

    findActualPropertyCalls(propertyName: string) {
        return this.calls.actual.filter(x => 
            x.property.name === propertyName);
    }

    removeLastCall() {
        const lastCall = this.getLastCall();
        if(!lastCall)
            return;

        lastCall.callCount--;
        if(lastCall.callCount <= 0) 
            lastCall.callCount = 0;

        console.log('removed call', this.calls.actual);
    }

    findActualMethodCalls(propertyName: string, args?: any[]) {
        let result = this.calls
            .actual
            .filter(x => x.property.name === propertyName)
            .filter(x => {
                if(args === void 0)
                    return true;

                if(x.property.type !== 'function') 
                    return false;
                
                const args1 = [...x.property.method.arguments];
                const args2 = args;

                if(!args1 || !args2)
                    return false;

                const firstArg1 = args1[0];
                const firstArg2 = args2[0];
                if(firstArg1 instanceof AllArguments || firstArg2 instanceof AllArguments)
                    return true;

                if(args1.length !== args2.length)
                    return false;

                for(let i=0;i<args1.length;i++) {
                    const arg1 = args1[i];
                    const arg2 = args2[i];

                    if(!areArgumentsEqual(arg1, arg2)) 
                        return false;
                }

                return true;
            });

        return result;
    }

    getLastCall() {
        return this.calls.actual[this.calls.actual.length-1];
    }

    removeActualPropertyCall(call: ProxyCallRecord) {
        const callIndex = this.calls.actual.indexOf(call);
        this.calls.actual.splice(callIndex, 1);
    }

    addActualCall() {
        let existingCall: ProxyCallRecord;

        const existingCallCandidates = this.calls.actual.filter(x => 
            x.property.name === this.property.name);

        const thisProperty = this.property;
        if(thisProperty.type === 'function') {
            for(let existingCallCandidate of existingCallCandidates.filter(x => x.property.type === 'object')) {
                const index = this.calls.actual.indexOf(existingCallCandidate);
                if(index > -1)
                    this.calls.actual.splice(index, 1);
            }

            existingCall = existingCallCandidates.filter(x => 
                x.property.type === 'function' &&
                areArgumentsEqual(x.property.method.arguments, thisProperty.method.arguments))[0];
        } else {
            existingCall = existingCallCandidates[0];
        }
            
        if(!existingCall) {
            existingCall = new ProxyCallRecord(this.property);
            this.calls.actual.push(existingCall);
        } else if(thisProperty.type === 'function' && existingCall.property.type === 'function') {
            existingCall.property.method.arguments = [...thisProperty.method.arguments];
        }

        existingCall.callCount++;

        console.log('added call', this.calls.actual);

        return existingCall;
    }
}

export class ProxyCallRecord {
    callCount: number;

    property: ProxyPropertyContext | ProxyMethodPropertyContext;

    constructor(property?: ProxyPropertyContext | ProxyMethodPropertyContext) {
        this.callCount = 0;
        this.property = property;
    }

    seal() {
        if(!this.property)
            return;
        
        this.property = this.property.clone();
    }
}